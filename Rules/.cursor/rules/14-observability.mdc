---
description: ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Observability. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸, Ñ‚Ñ€ĞµĞ¹ÑĞ¸Ğ½Ğ³, Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³.
globs: ["**/*.ts", "**/*.tsx", "**/api/**", "**/server/**"]
alwaysApply: false
---

# ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ OBSERVABILITY

> Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¸Ğ·Ğ¼ĞµÑ€Ğ¸Ñ‚ÑŒ â€” Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ. Ğ›Ğ¾Ğ³Ğ¸, Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸, Ñ‚Ñ€ĞµĞ¹ÑÑ‹ = Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹.

---

## ğŸ¯ Ğ“Ğ›ĞĞ’ĞĞ«Ğ• ĞŸĞ Ğ˜ĞĞ¦Ğ˜ĞŸĞ«

1. **Structured Logging** â€” JSON Ğ»Ğ¾Ğ³Ğ¸ Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
2. **Correlation** â€” Request ID Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ‡ĞµÑ€ĞµĞ· Ğ²ÑÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ
3. **Levels** â€” Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
4. **No PII** â€” Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…

---

## ğŸ“Š Ğ¢Ğ Ğ˜ Ğ¡Ğ¢ĞĞ›ĞŸĞ OBSERVABILITY

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OBSERVABILITY                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     LOGS        â”‚    METRICS      â”‚     TRACES          â”‚
â”‚                 â”‚                 â”‚                     â”‚
â”‚  Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ¾  â”‚  Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾/ĞºĞ¾Ğ³Ğ´Ğ°  â”‚  ĞŸÑƒÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°       â”‚
â”‚  Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ â”‚  ĞĞ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ â”‚  Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ     â”‚
â”‚  Debug/Troubleshootâ”‚ ĞĞ»ĞµÑ€Ñ‚Ñ‹/Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ñ‹â”‚  Ğ›Ğ°Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•

### Ğ£Ñ€Ğ¾Ğ²Ğ½Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

| Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ | ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ | Production |
|---------|-------------------|------------|
| `error` | ĞÑˆĞ¸Ğ±ĞºĞ¸, Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‰Ğ¸Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ | âœ… Ğ”Ğ° |
| `warn` | ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ | âœ… Ğ”Ğ° |
| `info` | Ğ’Ğ°Ğ¶Ğ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ | âœ… Ğ”Ğ° |
| `debug` | Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ | âŒ ĞĞµÑ‚ |
| `trace` | ĞÑ‡ĞµĞ½ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ | âŒ ĞĞµÑ‚ |

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸

```typescript
// lib/logger.ts
import pino from 'pino';

const isProduction = process.env.NODE_ENV === 'production';

export const logger = pino({
  level: isProduction ? 'info' : 'debug',
  
  // JSON Ğ² production, pretty Ğ² development
  transport: isProduction
    ? undefined
    : {
        target: 'pino-pretty',
        options: {
          colorize: true,
          translateTime: 'HH:MM:ss',
        },
      },
  
  // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ»Ğ¾Ğ³Ğ¾Ğ²
  base: {
    service: process.env.SERVICE_NAME || 'app',
    env: process.env.NODE_ENV,
    version: process.env.APP_VERSION,
  },
  
  // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ timestamp
  timestamp: pino.stdTimeFunctions.isoTime,
  
  // Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
  redact: {
    paths: [
      'password',
      'passwordHash',
      'token',
      'accessToken',
      'refreshToken',
      'authorization',
      'cookie',
      'creditCard',
      '*.password',
      '*.token',
    ],
    censor: '[REDACTED]',
  },
});

// Child logger Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
export function createLogger(context: Record<string, unknown>) {
  return logger.child(context);
}
```

### ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```typescript
// âœ… ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ â€” ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼

// INFO â€” Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
logger.info({
  event: 'order.created',
  orderId: order.id,
  userId: user.id,
  total: order.total,
  itemCount: order.items.length,
}, 'Order created successfully');

// WARN â€” Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹
logger.warn({
  event: 'payment.retry',
  orderId,
  attempt: 3,
  maxAttempts: 5,
}, 'Payment retry attempt');

// ERROR â€” Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
logger.error({
  event: 'payment.failed',
  orderId,
  errorCode: error.code,
  errorMessage: error.message,
  stack: error.stack,
}, 'Payment processing failed');

// DEBUG â€” Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ (Ğ½Ğµ Ğ² production)
logger.debug({
  event: 'cache.miss',
  key: cacheKey,
  duration: fetchTime,
}, 'Cache miss, fetched from database');
```

```typescript
// âŒ ĞĞ•ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ

// ĞĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹
logger.info('Order created');

// ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
logger.info({ email, password }, 'User login');

// Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ² info
logger.info({ fullRequest, fullResponse }, 'API call');

// ĞĞµÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´Ğ»Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
logger.error('Something went wrong');
```

### Request Logging Middleware

```typescript
// middleware/request-logger.ts
import { Request, Response, NextFunction } from 'express';
import { v4 as uuid } from 'uuid';
import { logger } from '@/lib/logger';

export function requestLogger(
  req: Request,
  res: Response,
  next: NextFunction,
) {
  // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ±ĞµÑ€Ñ‘Ğ¼ requestId
  const requestId = (req.headers['x-request-id'] as string) || uuid();
  req.headers['x-request-id'] = requestId;
  res.setHeader('x-request-id', requestId);

  // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ logger Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
  const reqLogger = logger.child({
    requestId,
    method: req.method,
    path: req.path,
    userAgent: req.headers['user-agent'],
    ip: req.ip,
    userId: (req as any).user?.id,
  });

  // Ğ’Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
  const startTime = Date.now();

  // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
  reqLogger.info({ event: 'request.start' }, 'Incoming request');

  // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    const level = res.statusCode >= 400 ? 'warn' : 'info';

    reqLogger[level]({
      event: 'request.end',
      statusCode: res.statusCode,
      duration,
    }, `Request completed in ${duration}ms`);
  });

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ logger Ğ² request Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² handlers
  (req as any).logger = reqLogger;

  next();
}
```

### NestJS Logger

```typescript
// common/logger/logger.service.ts
import { Injectable, LoggerService, Scope } from '@nestjs/common';
import { logger as pinoLogger } from '@/lib/logger';
import type { Logger } from 'pino';

@Injectable({ scope: Scope.TRANSIENT })
export class AppLogger implements LoggerService {
  private context?: string;
  private logger: Logger;

  constructor() {
    this.logger = pinoLogger;
  }

  setContext(context: string) {
    this.context = context;
    this.logger = pinoLogger.child({ context });
  }

  log(message: string, context?: Record<string, unknown>) {
    this.logger.info(context || {}, message);
  }

  error(message: string, trace?: string, context?: Record<string, unknown>) {
    this.logger.error({ ...context, stack: trace }, message);
  }

  warn(message: string, context?: Record<string, unknown>) {
    this.logger.warn(context || {}, message);
  }

  debug(message: string, context?: Record<string, unknown>) {
    this.logger.debug(context || {}, message);
  }
}

// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² ÑĞµÑ€Ğ²Ğ¸ÑĞµ
@Injectable()
export class OrdersService {
  private readonly logger = new AppLogger();

  constructor() {
    this.logger.setContext(OrdersService.name);
  }

  async create(dto: CreateOrderDto, userId: string) {
    this.logger.log('Creating order', { userId, itemCount: dto.items.length });
    
    try {
      const order = await this.processOrder(dto);
      this.logger.log('Order created', { orderId: order.id, userId });
      return order;
    } catch (error) {
      this.logger.error('Failed to create order', error.stack, {
        userId,
        errorCode: error.code,
      });
      throw error;
    }
  }
}
```

---

## ğŸ“ˆ ĞœĞ•Ğ¢Ğ Ğ˜ĞšĞ˜

### Ğ¢Ğ¸Ğ¿Ñ‹ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº

| Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ |
|-----|----------|--------|
| Counter | Ğ¡Ñ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚) | ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² |
| Gauge | Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ |
| Histogram | Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹ | Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° |
| Summary | ĞšĞ²Ğ°Ğ½Ñ‚Ğ¸Ğ»Ğ¸ | P50, P95, P99 Ğ»Ğ°Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ |

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸

```typescript
// metrics/app.metrics.ts

// HTTP Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
export const httpMetrics = {
  // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
  requestsTotal: new Counter({
    name: 'http_requests_total',
    help: 'Total number of HTTP requests',
    labelNames: ['method', 'path', 'status'],
  }),

  // Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
  requestDuration: new Histogram({
    name: 'http_request_duration_seconds',
    help: 'HTTP request duration in seconds',
    labelNames: ['method', 'path', 'status'],
    buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],
  }),

  // ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
  requestsInProgress: new Gauge({
    name: 'http_requests_in_progress',
    help: 'Number of HTTP requests in progress',
    labelNames: ['method'],
  }),
};

// Ğ‘Ğ¸Ğ·Ğ½ĞµÑ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
export const businessMetrics = {
  ordersCreated: new Counter({
    name: 'orders_created_total',
    help: 'Total number of orders created',
    labelNames: ['status'],
  }),

  orderValue: new Histogram({
    name: 'order_value_amount',
    help: 'Order value distribution',
    buckets: [10, 50, 100, 500, 1000, 5000],
  }),

  paymentProcessingTime: new Histogram({
    name: 'payment_processing_seconds',
    help: 'Payment processing time',
    labelNames: ['provider'],
    buckets: [0.5, 1, 2, 5, 10, 30],
  }),
};

// Database Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
export const dbMetrics = {
  queryDuration: new Histogram({
    name: 'db_query_duration_seconds',
    help: 'Database query duration',
    labelNames: ['operation', 'table'],
    buckets: [0.001, 0.01, 0.05, 0.1, 0.5, 1],
  }),

  connectionPoolSize: new Gauge({
    name: 'db_connection_pool_size',
    help: 'Database connection pool size',
    labelNames: ['state'], // active, idle, waiting
  }),
};
```

### RED Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²)

```
Rate     â€” Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² ÑĞµĞºÑƒĞ½Ğ´Ñƒ
Errors   â€” Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
Duration â€” Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (P50, P95, P99)
```

### USE Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Ğ´Ğ»Ñ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²)

```
Utilization â€” % Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
Saturation  â€” Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ/Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ
Errors      â€” ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
```

---

## ğŸ”— DISTRIBUTED TRACING

### Correlation ID

```typescript
// middleware/correlation.ts

export function correlationMiddleware(
  req: Request,
  res: Response,
  next: NextFunction,
) {
  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ correlation ID
  const correlationId = 
    req.headers['x-correlation-id'] as string ||
    req.headers['x-request-id'] as string ||
    uuid();

  // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸
  req.headers['x-correlation-id'] = correlationId;
  res.setHeader('x-correlation-id', correlationId);

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² AsyncLocalStorage Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ²ĞµĞ·Ğ´Ğµ
  correlationStorage.run({ correlationId }, () => {
    next();
  });
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ correlation ID Ğ² Ğ»ÑĞ±Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ ĞºĞ¾Ğ´Ğ°
export function getCorrelationId(): string | undefined {
  return correlationStorage.getStore()?.correlationId;
}
```

### ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ² Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹

```typescript
// lib/api-client.ts

export async function externalApiCall<T>(
  url: string,
  options?: RequestInit,
): Promise<T> {
  const correlationId = getCorrelationId();

  const response = await fetch(url, {
    ...options,
    headers: {
      ...options?.headers,
      'x-correlation-id': correlationId || uuid(),
    },
  });

  return response.json();
}
```

### OpenTelemetry (Ğ´Ğ»Ñ ĞºÑ€ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ğ²)

```typescript
// instrumentation.ts
import { NodeSDK } from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

const sdk = new NodeSDK({
  serviceName: process.env.SERVICE_NAME,
  traceExporter: new OTLPTraceExporter({
    url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT,
  }),
  instrumentations: [
    getNodeAutoInstrumentations({
      '@opentelemetry/instrumentation-fs': { enabled: false },
    }),
  ],
});

sdk.start();
```

---

## ğŸš¨ ĞĞ›Ğ•Ğ Ğ¢Ğ˜ĞĞ“

### ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ°Ğ»ĞµÑ€Ñ‚Ğ¾Ğ²

```yaml
# ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ (ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ Ñ€ĞµĞ°Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ)
- alert: HighErrorRate
  condition: error_rate > 5%
  for: 5m
  severity: critical

- alert: ServiceDown
  condition: up == 0
  for: 1m
  severity: critical

# ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ (Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒÑÑ)
- alert: HighLatency
  condition: p99_latency > 2s
  for: 10m
  severity: warning

- alert: DiskSpaceRunningLow
  condition: disk_usage > 80%
  for: 30m
  severity: warning
```

### SLI/SLO (Service Level Indicators/Objectives)

```markdown
## SLO Ğ´Ğ»Ñ API

| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | SLO | Ğ˜Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ |
|---------|-----|-----------|
| Availability | 99.9% | Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ / Ğ’ÑĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ |
| Latency P99 | < 500ms | 99-Ğ¹ Ğ¿ĞµÑ€Ñ†ĞµĞ½Ñ‚Ğ¸Ğ»ÑŒ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° |
| Error Rate | < 0.1% | 5xx Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ / Ğ’ÑĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ |

## Error Budget

- SLO 99.9% = 0.1% Ğ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ñ‹Ñ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
- 43.2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ downtime Ğ² Ğ¼ĞµÑÑÑ†
- Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ â€” Ğ·Ğ°Ğ¼Ğ¾Ñ€Ğ¾Ğ·ĞºĞ° Ñ€ĞµĞ»Ğ¸Ğ·Ğ¾Ğ²
```

---

## ğŸ“‹ Ğ§Ğ¢Ğ Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞ¢Ğ¬

### âœ… Ğ›ĞĞ“Ğ˜Ğ Ğ£Ğ™

```typescript
// Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
logger.info({ event: 'user.registered', userId });
logger.info({ event: 'order.created', orderId, total });
logger.info({ event: 'payment.completed', orderId, amount });

// ĞÑˆĞ¸Ğ±ĞºĞ¸ Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
logger.error({ event: 'payment.failed', orderId, errorCode, stack });

// ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
logger.info({ event: 'db.query', duration, query: 'findUsers' });

// Security ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
logger.warn({ event: 'auth.failed', ip, email: maskEmail(email) });
logger.info({ event: 'password.changed', userId });
```

### âŒ ĞĞ• Ğ›ĞĞ“Ğ˜Ğ Ğ£Ğ™

```typescript
// ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
logger.info({ password, ssn, creditCard }); // âŒ

// Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ Ğ¸ ÑĞµĞºÑ€ĞµÑ‚Ñ‹
logger.debug({ accessToken, apiKey }); // âŒ

// Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
logger.info({ fullRequestBody, fullResponseBody }); // âŒ

// ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
logger.debug('Entering function X'); // âŒ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ ÑˆÑƒĞ¼Ğ½Ğ¾
```

---

## ğŸ“‹ CHECKLIST

### Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

- [ ] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ structured logging (JSON)
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ (info Ğ² prod)
- [ ] Request ID Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ»Ğ¾Ğ³Ğµ
- [ ] ĞĞµÑ‚ PII/ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…
- [ ] ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ¸ stack trace
- [ ] Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸

- [ ] HTTP Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (rate, errors, duration)
- [ ] Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (orders, payments, etc.)
- [ ] Database Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (query time, connections)
- [ ] ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ñ‡ĞµÑ€ĞµĞ· /metrics endpoint

### ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

- [ ] Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ñ‹ Ğ´Ğ»Ñ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
- [ ] ĞĞ»ĞµÑ€Ñ‚Ñ‹ Ğ½Ğ° ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
- [ ] SLO Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹ Ğ¸ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ

---

**Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0
**Ğ”Ğ°Ñ‚Ğ°:** 2025-01-31
