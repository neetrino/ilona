---
description: –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Å—Ö–µ–º–∞–º, –º–∏–≥—Ä–∞—Ü–∏—è–º –∏ –∑–∞–ø—Ä–æ—Å–∞–º.
globs: ["**/prisma/**", "**/*.prisma", "**/db/**", "**/database/**", "**/migrations/**"]
alwaysApply: false
---

# –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–•

> PostgreSQL –∫–∞–∫ –æ—Å–Ω–æ–≤–∞. Prisma –∫–∞–∫ ORM. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

---

## üéØ –ì–õ–ê–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´

1. **PostgreSQL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** ‚Äî –¥–ª—è 95% –ø—Ä–æ–µ–∫—Ç–æ–≤
2. **Prisma ORM** ‚Äî –Ω–∏–∫–∞–∫–∏—Ö raw SQL –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã** ‚Äî –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏
4. **–ò–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–¥—É–º–∞–Ω—ã** ‚Äî –¥–ª—è –≤—Å–µ—Ö —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üóÑÔ∏è –í–´–ë–û–† –ë–ê–ó–´ –î–ê–ù–ù–´–•

### –ö–æ–≥–¥–∞ –∫–∞–∫—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | –ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|-------------|-------------------|----------------------|
| **PostgreSQL** | 95% –ø—Ä–æ–µ–∫—Ç–æ–≤, ACID, —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–µ–∫—Ç—ã |
| **MongoDB** | –î–æ–∫—É–º–µ–Ω—Ç—ã, –≥–∏–±–∫–∞—è —Å—Ö–µ–º–∞, –ø—Ä–æ—Ç–æ—Ç–∏–ø—ã | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å–≤—è–∑–∏ –¥–∞–Ω–Ω—ã—Ö |
| **SQLite** | –ü—Ä–æ—Ç–æ—Ç–∏–ø—ã, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | Production web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| **Redis** | –ö—ç—à, —Å–µ—Å—Å–∏–∏, –æ—á–µ—Ä–µ–¥–∏ | –û—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ |

### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç–µ–∫

```
Production:
‚îú‚îÄ‚îÄ PostgreSQL 15+ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î
‚îú‚îÄ‚îÄ Redis 7+ ‚Äî –∫—ç—à –∏ –æ—á–µ—Ä–µ–¥–∏
‚îî‚îÄ‚îÄ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) Elasticsearch ‚Äî –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
```

---

## üìù PRISMA SCHEMA

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ schema.prisma

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
// ==========================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // –°–≤—è–∑–∏
  orders    Order[]
  sessions  Session[]
  
  @@index([email])
  @@index([role, isActive])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  MANAGER
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// ==========================================
// –ü–†–û–î–£–ö–¢–´ –ò –ö–ê–¢–ï–ì–û–†–ò–ò
// ==========================================

model Category {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  description String?
  parentId    String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // –°–≤—è–∑–∏
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  products Product[]
  
  @@index([slug])
  @@index([parentId])
  @@index([isActive, sortOrder])
  @@map("categories")
}

model Product {
  id          String  @id @default(cuid())
  slug        String  @unique
  sku         String? @unique
  name        String
  description String?
  price       Int     // –¶–µ–Ω–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  comparePrice Int?   // –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Å–∫–∏–¥–∫–∏
  stock       Int     @default(0)
  categoryId  String
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // –°–≤—è–∑–∏
  category   Category    @relation(fields: [categoryId], references: [id])
  variants   Variant[]
  images     Image[]
  orderItems OrderItem[]
  
  @@index([slug])
  @@index([sku])
  @@index([categoryId])
  @@index([isActive, isFeatured])
  @@index([price])
  @@map("products")
}

model Variant {
  id        String @id @default(cuid())
  productId String
  sku       String @unique
  name      String // "–ö—Ä–∞—Å–Ω—ã–π, L"
  price     Int?   // –°–≤–æ—è —Ü–µ–Ω–∞ –∏–ª–∏ null = —Ü–µ–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
  stock     Int    @default(0)
  
  // –ê—Ç—Ä–∏–±—É—Ç—ã –∫–∞–∫ JSON
  attributes Json @default("{}")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  
  @@index([productId])
  @@index([sku])
  @@map("variants")
}

model Image {
  id        String @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int    @default(0)
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
  @@map("images")
}

// ==========================================
// –ó–ê–ö–ê–ó–´
// ==========================================

model Order {
  id          String      @id @default(cuid())
  number      String      @unique // ORD-2024-00001
  userId      String?
  status      OrderStatus @default(PENDING)
  
  // –°—É–º–º—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  subtotal    Int
  discount    Int         @default(0)
  shipping    Int         @default(0)
  total       Int
  
  // –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏
  shippingAddress Json
  billingAddress  Json?
  
  // –ö–æ–Ω—Ç–∞–∫—Ç
  email       String
  phone       String
  
  // –ú–µ—Ç–∞
  notes       String?
  metadata    Json        @default("{}")
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // –°–≤—è–∑–∏
  user        User?       @relation(fields: [userId], references: [id])
  items       OrderItem[]
  payments    Payment[]
  events      OrderEvent[]
  
  @@index([number])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  variantId String?
  
  name      String // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞
  sku       String
  price     Int    // –¶–µ–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞
  quantity  Int
  total     Int    // price * quantity
  
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product  @relation(fields: [productId], references: [id])
  variant Variant? @relation(fields: [variantId], references: [id])
  
  @@index([orderId])
  @@map("order_items")
}

model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  type      String   // status_changed, payment_received, note_added
  data      Json     @default("{}")
  createdAt DateTime @default(now())
  createdBy String?  // User ID –∏–ª–∏ 'system'
  
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
  @@index([type])
  @@map("order_events")
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String
  provider      String        // stripe, idram, arca
  externalId    String?       @unique
  status        PaymentStatus @default(PENDING)
  amount        Int
  currency      String        @default("AMD")
  metadata      Json          @default("{}")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  order Order @relation(fields: [orderId], references: [id])
  
  @@index([orderId])
  @@index([externalId])
  @@index([status])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}
```

---

## üîß –ü–†–ê–í–ò–õ–ê –°–•–ï–ú–´

### –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ

```prisma
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
model User { ... }           // PascalCase –¥–ª—è –º–æ–¥–µ–ª–µ–π
model OrderItem { ... }      // PascalCase —Å–æ—Å—Ç–∞–≤–Ω—ã–µ

// –ü–æ–ª—è ‚Äî camelCase
firstName String
createdAt DateTime
isActive  Boolean

// Enum ‚Äî UPPER_SNAKE –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π
enum OrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// –¢–∞–±–ª–∏—Ü—ã ‚Äî snake_case —á–µ—Ä–µ–∑ @@map
model OrderItem {
  ...
  @@map("order_items")
}
```

### ID —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

```prisma
// ‚úÖ CUID ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (–∫–æ—Ä–æ—á–µ UUID, —Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–π)
id String @id @default(cuid())

// ‚úÖ UUID ‚Äî –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
id String @id @default(uuid())

// ‚ö†Ô∏è Auto-increment ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü
id Int @id @default(autoincrement())
```

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

```prisma
// ‚úÖ –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π timestamps
model Entity {
  id        String   @id @default(cuid())
  // ... –ø–æ–ª—è
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

---

## üìä –ò–ù–î–ï–ö–°–´

### –ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å—ã

```prisma
// ‚úÖ –ü–æ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞
@@index([email])
@@index([slug])

// ‚úÖ –ü–æ–ª—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
@@index([status])
@@index([isActive])
@@index([categoryId])

// ‚úÖ –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
@@index([isActive, createdAt])
@@index([userId, status])

// ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
email String @unique
slug  String @unique

// ‚úÖ –°–æ—Å—Ç–∞–≤–Ω–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π
@@unique([productId, variantId])
```

### –ß—Ç–æ –ù–ï –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å

```prisma
// ‚ùå –ù–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–π:
// - –ü–æ–ª—è —Å –Ω–∏–∑–∫–æ–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é (boolean —Å 50/50)
// - –†–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ WHERE
// - –ë–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (description)
```

---

## üîÑ –ú–ò–ì–†–ê–¶–ò–ò

### Workflow –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# 1. –ò–∑–º–µ–Ω–∏—Ç—å schema.prisma

# 2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (development)
npx prisma migrate dev --name add_user_role

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (production)
npx prisma migrate deploy

# 4. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç
npx prisma generate
```

### –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞
add_users_table
add_user_email_index
add_order_status_column
rename_price_to_amount
remove_deprecated_field

# ‚ùå –ü–õ–û–•–û
update
fix
changes
migration1
```

### –û–ø–∞—Å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```prisma
// ‚ö†Ô∏è –û–°–¢–û–†–û–ñ–ù–û ‚Äî –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö

// –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
// –°–ù–ê–ß–ê–õ–ê: —É–±–µ–¥–∏—Å—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω—É–∂–Ω—ã –∏–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã

// –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏  
// –ò–°–ü–û–õ–¨–ó–£–ô: @map –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
model User {
  firstName String @map("first_name") // –ë—ã–ª–æ first_name –≤ –ë–î
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞
// –°–û–ó–î–ê–ô: –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É, –º–∏–≥—Ä–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ, —É–¥–∞–ª–∏ —Å—Ç–∞—Ä—É—é
```

---

## üìù –ó–ê–ü–†–û–°–´ PRISMA

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

```typescript
// ‚úÖ Select —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
const users = await prisma.user.findMany({
  select: {
    id: true,
    name: true,
    email: true,
  },
});

// ‚úÖ Include –¥–ª—è —Å–≤—è–∑–µ–π
const order = await prisma.order.findUnique({
  where: { id: orderId },
  include: {
    items: true,
    user: {
      select: { id: true, name: true, email: true },
    },
  },
});

// ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è
const products = await prisma.product.findMany({
  skip: (page - 1) * limit,
  take: limit,
  orderBy: { createdAt: 'desc' },
});

// ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
const [order, payment] = await prisma.$transaction([
  prisma.order.create({ data: orderData }),
  prisma.payment.create({ data: paymentData }),
]);

// ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
const result = await prisma.$transaction(async (tx) => {
  const product = await tx.product.findUnique({ where: { id } });
  
  if (product.stock < quantity) {
    throw new Error('Insufficient stock');
  }
  
  await tx.product.update({
    where: { id },
    data: { stock: { decrement: quantity } },
  });
  
  return tx.orderItem.create({ data: itemData });
});
```

### –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã

```typescript
// ‚ùå N+1 –ø—Ä–æ–±–ª–µ–º–∞
const orders = await prisma.order.findMany();
for (const order of orders) {
  const items = await prisma.orderItem.findMany({
    where: { orderId: order.id },
  }); // N –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤!
}

// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π include
const orders = await prisma.order.findMany({
  include: { items: true },
});

// ‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
const allProducts = await prisma.product.findMany(); // –ú–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π!

// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞–≥–∏–Ω–∞—Ü–∏—é
const products = await prisma.product.findMany({
  take: 100,
  skip: offset,
});

// ‚ùå Raw SQL –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
const users = await prisma.$queryRaw`SELECT * FROM users WHERE ...`;

// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π Prisma Query API
const users = await prisma.user.findMany({
  where: { ... },
});
```

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ó–∞—â–∏—Ç–∞ –æ—Ç SQL Injection

```typescript
// ‚úÖ Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
const user = await prisma.user.findFirst({
  where: { email: userInput }, // –ë–µ–∑–æ–ø–∞—Å–Ω–æ
});

// ‚ö†Ô∏è Raw SQL ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
const result = await prisma.$queryRaw`
  SELECT * FROM users WHERE email = ${userInput}
`; // Prisma —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç

// ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä—É–π —Å—Ç—Ä–æ–∫–∏
const result = await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE email = '${userInput}'` // SQL INJECTION!
);
```

### –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

```prisma
model Product {
  id        String    @id @default(cuid())
  // ...
  deletedAt DateTime? // null = –∞–∫—Ç–∏–≤–µ–Ω, –¥–∞—Ç–∞ = —É–¥–∞–ª—ë–Ω
  
  @@index([deletedAt])
}
```

```typescript
// Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
prisma.$use(async (params, next) => {
  if (params.model === 'Product') {
    if (params.action === 'findMany' || params.action === 'findFirst') {
      params.args.where = {
        ...params.args.where,
        deletedAt: null,
      };
    }
  }
  return next(params);
});
```

---

## üíæ BACKUP –ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –±—ç–∫–∞–ø–æ–≤

```markdown
## –¢–∏–ø—ã –±—ç–∫–∞–ø–æ–≤

| –¢–∏–ø | –ß–∞—Å—Ç–æ—Ç–∞ | Retention | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|-----|---------|-----------|-------------------|
| Full backup | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ | 30 –¥–Ω–µ–π | –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ |
| Incremental | –ö–∞–∂–¥—ã–π —á–∞—Å | 7 –¥–Ω–µ–π | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ—á–∫—É |
| WAL archiving | –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ | 7 –¥–Ω–µ–π | Point-in-time recovery |
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±—ç–∫–∞–ø–æ–≤ PostgreSQL

```bash
# –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø
pg_dump -h localhost -U user -d database -F c -f backup_$(date +%Y%m%d).dump

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
pg_restore -h localhost -U user -d database -c backup_20240115.dump

# –ë—ç–∫–∞–ø —Ç–æ–ª—å–∫–æ —Å—Ö–µ–º—ã
pg_dump -h localhost -U user -d database --schema-only -f schema.sql

# –ë—ç–∫–∞–ø —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö
pg_dump -h localhost -U user -d database --data-only -f data.sql
```

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (Docker/Kubernetes)

```yaml
# docker-compose.yml ‚Äî backup service
services:
  backup:
    image: postgres:15-alpine
    environment:
      PGHOST: postgres
      PGUSER: ${DB_USER}
      PGPASSWORD: ${DB_PASSWORD}
      PGDATABASE: ${DB_NAME}
    volumes:
      - ./backups:/backups
    command: |
      sh -c 'while true; do
        pg_dump -F c -f /backups/backup_$$(date +%Y%m%d_%H%M%S).dump
        find /backups -mtime +30 -delete
        sleep 86400
      done'
```

### üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: Restore Testing

```markdown
## Checklist —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### –ï–∂–µ–º–µ—Å—è—á–Ω–æ
- [ ] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø –≤ —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- [ ] –ó–∞–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (RTO)
- [ ] –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- [ ] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∫–ª—é—á–µ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- [ ] –°–≤—è–∑–∏ (FK) –Ω–µ –Ω–∞—Ä—É—à–µ–Ω—ã
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –∑–∞–∫–∞–∑—ã, –ø–ª–∞—Ç–µ–∂–∏)
```

### Runbook –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```markdown
## –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∫–æ–π –±—ç–∫–∞–ø)
- –£–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –æ downtime
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —á–∏—Å—Ç—É—é –ë–î –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é

### 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
\`\`\`bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
docker-compose stop app

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î
pg_restore -h localhost -U user -d database -c backup.dump

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
psql -h localhost -U user -d database -c "SELECT COUNT(*) FROM users;"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
docker-compose start app
\`\`\`

### 3. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
- [ ] Health checks –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Smoke tests –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –Ω–æ—Ä–º–µ

### 4. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è
- –£–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- –°–æ–∑–¥–∞—Ç—å incident report
```

### –ú–µ—Ç—Ä–∏–∫–∏ –±—ç–∫–∞–ø–æ–≤

```typescript
// –ß—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å
const backupMetrics = {
  lastBackupTime: Date,        // –ö–æ–≥–¥–∞ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø
  backupSize: number,          // –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞
  backupDuration: number,      // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞
  lastRestoreTest: Date,       // –ö–æ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  restoreDuration: number,     // –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (RTO)
};

// –ê–ª–µ—Ä—Ç—ã
// - –ë—ç–∫–∞–ø –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è > 24 —á–∞—Å–æ–≤
// - Restore test –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è > 30 –¥–Ω–µ–π
// - –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞ –∞–Ω–æ–º–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è
```

---

## ‚òÅÔ∏è NEON (MANAGED POSTGRES)

> –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Neon ‚Äî –º–Ω–æ–≥–∏–µ —Å–µ–∫—Ü–∏–∏ –≤—ã—à–µ —É–ø—Ä–æ—â–∞—é—Ç—Å—è.

### –ß—Ç–æ Neon –¥–µ–ª–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

```markdown
## –ë—ç–∫–∞–ø—ã
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã (–Ω–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å)
- ‚úÖ Point-in-time recovery (–¥–æ 7/30 –¥–Ω–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–∞–Ω–∞)
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–µ—Å—Ç–µ (S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

## Branching
- ‚úÖ Database branches (–∫–∞–∫ git branches –¥–ª—è –ë–î)
- ‚úÖ Preview environments —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π –ë–î
- ‚úÖ Instant branching (copy-on-write)

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ Autoscaling compute
- ‚úÖ Scale to zero (—ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ dev)
- ‚úÖ Read replicas (–Ω–∞ Pro –ø–ª–∞–Ω–µ)
```

### Neon Branching –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –í–º–µ—Å—Ç–æ docker-compose —Å –ª–æ–∫–∞–ª—å–Ω—ã–º Postgres:
# 1. Main branch = production
# 2. Dev branch = –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# 3. PR branches = –¥–ª—è preview deployments

# –°–æ–∑–¥–∞–Ω–∏–µ branch —á–µ—Ä–µ–∑ Neon CLI
neonctl branches create --name feature-auth

# –ò–ª–∏ —á–µ—Ä–µ–∑ Vercel Integration ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ PR
```

### Connection String

```typescript
// .env.local (development)
DATABASE_URL="postgresql://user:pass@ep-xxx-123.us-east-2.aws.neon.tech/neondb?sslmode=require"

// Prisma ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è serverless
// schema.prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // –î–ª—è –º–∏–≥—Ä–∞—Ü–∏–π (–±–µ–∑ connection pooling)
}
```

### –ß—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å

```markdown
## –í–∞—à–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

- ‚úÖ –°—Ö–µ–º–∞ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (Prisma)
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–±–µ–∑ N+1)
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≥–¥–µ –Ω—É–∂–Ω–æ
- ‚úÖ Soft delete –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## –ù–ï –Ω—É–∂–Ω–æ (Neon –¥–µ–ª–∞–µ—Ç)

- ‚ùå –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –±—ç–∫–∞–ø—ã
- ‚ùå docker-compose –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
- ‚ùå Restore testing (Neon –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç)
- ‚ùå –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
```

### Neon + Vercel Integration

```markdown
## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. Preview deployment ‚Üí Neon —Å–æ–∑–¥–∞—ë—Ç branch
2. PR merged ‚Üí branch —É–¥–∞–ª—è–µ—Ç—Å—è
3. Environment variables –ø—Ä–æ–∫–∏–¥—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

---

## üìã CHECKLIST

### –ü–µ—Ä–µ–¥ production

- [ ] –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- [ ] –ù–µ—Ç N+1 –ø—Ä–æ–±–ª–µ–º
- [ ] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] Backup –Ω–∞—Å—Ç—Ä–æ–µ–Ω *(–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ Neon)*
- [ ] **Restore testing –ø—Ä–æ–≤–µ–¥—ë–Ω** *(–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –µ—Å–ª–∏ Neon)*
- [ ] **RTO/RPO –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã** *(Neon: RPO ~0, RTO –º–∏–Ω—É—Ç—ã)*

### Backup Checklist (self-hosted)

> –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Neon –∏–ª–∏ –¥—Ä—É–≥–æ–π managed —Å–µ—Ä–≤–∏—Å

- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Retention policy –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
- [ ] –ë—ç–∫–∞–ø—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–µ—Å—Ç–µ (–Ω–µ –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ)
- [ ] Restore testing –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ (–º–∏–Ω–∏–º—É–º –µ–∂–µ–º–µ—Å—è—á–Ω–æ)
- [ ] Runbook –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±—ç–∫–∞–ø–æ–≤

### Neon Checklist

- [ ] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–ª–∞–Ω –≤—ã–±—Ä–∞–Ω (Free/Pro/Scale)
- [ ] Vercel Integration –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (–µ—Å–ª–∏ Vercel)
- [ ] Connection pooling –≤–∫–ª—é—á—ë–Ω
- [ ] `directUrl` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π

---

**–í–µ—Ä—Å–∏—è:** 1.2
**–î–∞—Ç–∞:** 2025-01-31
