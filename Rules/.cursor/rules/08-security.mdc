---
description: –ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º—É –∫–æ–¥—É.
globs: ["**/*"]
alwaysApply: false
---

# –ü–†–ê–í–ò–õ–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –Ω–µ –æ–ø—Ü–∏—è, –∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ. –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´.

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê

### –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–µ–ª–∞–π

```typescript
// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥–µ
const API_KEY = 'sk_live_abc123';
const DB_PASSWORD = 'mypassword';

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî SQL –∏–Ω—ä–µ–∫—Ü–∏–∏
const query = `SELECT * FROM users WHERE id = ${userId}`;
await db.$queryRawUnsafe(query);

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî eval –∏ –ø–æ–¥–æ–±–Ω—ã–µ
eval(userInput);
new Function(userInput)();

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
app.use(cors({ origin: '*' })); // –¢–æ–ª—å–∫–æ –¥–ª—è dev!
// CSRF –æ—Ç–∫–ª—é—á–µ–Ω

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
console.log('Password:', password);
logger.info({ token: accessToken });
```

---

## üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø

### –ü–∞—Ä–æ–ª–∏

```typescript
// ‚úÖ –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
import { hash, verify } from 'argon2';

// –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
const passwordHash = await hash(password, {
  type: argon2id,
  memoryCost: 65536,  // 64 MB
  timeCost: 3,
  parallelism: 4,
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
const isValid = await verify(user.passwordHash, password);

// ‚ùå –ù–ò–ö–û–ì–î–ê
const passwordHash = md5(password);     // –°–ª–∞–±—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
const passwordHash = sha256(password);  // –ë–µ–∑ salt
```

### JWT –¢–æ–∫–µ–Ω—ã

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ JWT
const accessToken = jwt.sign(
  { userId: user.id, role: user.role },
  process.env.JWT_SECRET,
  { 
    expiresIn: '15m',           // –ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫
    algorithm: 'RS256',         // –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
    issuer: 'api.example.com',
    audience: 'example.com',
  }
);

// Refresh token ‚Äî –¥–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫, —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
const refreshToken = jwt.sign(
  { userId: user.id, tokenId: uuid() },
  process.env.JWT_REFRESH_SECRET,
  { expiresIn: '7d' }
);

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
const token = jwt.sign(payload, 'secret'); // –°–ª–∞–±—ã–π —Å–µ–∫—Ä–µ—Ç
jwt.sign(payload, secret, { expiresIn: '30d' }); // –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –¥–ª—è access
```

### –°–µ—Å—Å–∏–∏

```typescript
// ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∫—É–∫–∏ –¥–ª—è —Å–µ—Å—Å–∏–π
res.cookie('sessionId', sessionId, {
  httpOnly: true,     // –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ JS
  secure: true,       // –¢–æ–ª—å–∫–æ HTTPS
  sameSite: 'strict', // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
  path: '/',
  domain: '.example.com',
});
```

---

## üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ê–¢–ê–ö

### XSS (Cross-Site Scripting)

```typescript
// ‚úÖ –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞
import { escape } from 'html-escaper';

const safeHtml = escape(userInput);

// ‚úÖ Content Security Policy
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.example.com"],
    },
  },
}));

// ‚úÖ React –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç
return <div>{userInput}</div>; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ

// ‚ùå –û–ü–ê–°–ù–û ‚Äî dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: userInput }} />
```

### CSRF (Cross-Site Request Forgery)

```typescript
// ‚úÖ CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ñ–æ—Ä–º
import csrf from 'csurf';

app.use(csrf({ cookie: true }));

// –í —Ñ–æ—Ä–º–µ
<input type="hidden" name="_csrf" value={csrfToken} />

// ‚úÖ SameSite cookies
res.cookie('session', value, { sameSite: 'strict' });
```

### SQL Injection

```typescript
// ‚úÖ Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—â–∏—â–∞–µ—Ç
const user = await prisma.user.findFirst({
  where: { email: userInput }, // –ë–µ–∑–æ–ø–∞—Å–Ω–æ
});

// ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
const result = await prisma.$queryRaw`
  SELECT * FROM users WHERE email = ${userInput}
`; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ ‚Äî Prisma —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç

// ‚ùå –ù–ò–ö–û–ì–î–ê
await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE email = '${userInput}'`
);
```

### NoSQL Injection

```typescript
// ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤
const userId = z.string().uuid().parse(userInput);

// ‚ùå –û–ü–ê–°–ù–û ‚Äî –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
const user = await db.findOne({ 
  _id: userInput // –ú–æ–∂–µ—Ç –±—ã—Ç—å { $ne: null }
});
```

---

## üîí –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø

### RBAC (Role-Based Access Control)

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('admin', 'manager')
@Delete(':id')
async delete(@Param('id') id: string) {
  return this.service.delete(id);
}

// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–∞
async updateOrder(orderId: string, userId: string, data: UpdateOrderDto) {
  const order = await this.prisma.order.findUnique({
    where: { id: orderId },
  });
  
  if (!order) {
    throw new NotFoundException();
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
  if (order.userId !== userId) {
    throw new ForbiddenException('You can only edit your own orders');
  }
  
  return this.prisma.order.update({
    where: { id: orderId },
    data,
  });
}
```

### –ü—Ä–∏–Ω—Ü–∏–ø –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

```typescript
// ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    name: true,
    email: true,
    // –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π: passwordHash, role, internalNotes
  },
});

// ‚úÖ –†–∞–∑–Ω—ã–µ DTO –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞
export class UserPublicDto {
  id: string;
  name: string;
}

export class UserPrivateDto extends UserPublicDto {
  email: string;
  phone: string;
}

export class UserAdminDto extends UserPrivateDto {
  role: string;
  createdAt: Date;
  lastLoginAt: Date;
}
```

---

## üîë –°–ï–ö–†–ï–¢–´

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# ‚úÖ Environment variables
DATABASE_URL=postgresql://...
JWT_SECRET=very-long-random-string
API_KEY=sk_live_...

# .env —Ñ–∞–π–ª –≤ .gitignore
# ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –∫–æ–º–º–∏—Ç—å .env

# ‚úÖ Production ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π secrets manager
# - AWS Secrets Manager
# - HashiCorp Vault
# - Kubernetes Secrets
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# ‚úÖ –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–µ —Å–µ–∫—Ä–µ—Ç—ã
openssl rand -base64 32  # –î–ª—è JWT_SECRET
openssl rand -hex 32     # –î–ª—è API –∫–ª—é—á–µ–π

# ‚ùå –ù–ò–ö–û–ì–î–ê
JWT_SECRET=secret
JWT_SECRET=12345
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
import { z } from 'zod';

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  JWT_SECRET: z.string().min(32),
  NODE_ENV: z.enum(['development', 'production', 'test']),
});

const env = envSchema.parse(process.env);

export default env;
```

---

## üìù –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•

### –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞

```typescript
// ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–π –í–°–Å –Ω–∞ –≤—Ö–æ–¥–µ
import { z } from 'zod';

const createUserSchema = z.object({
  email: z.string().email().max(255),
  password: z.string().min(8).max(100),
  name: z.string().min(1).max(100).optional(),
});

// ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
const sanitizedInput = input
  .trim()
  .replace(/[<>]/g, ''); // –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏

// ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
app.use(express.json({ limit: '1mb' }));
app.use(express.urlencoded({ limit: '1mb', extended: true }));
```

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
const MAX_SIZE = 5 * 1024 * 1024; // 5MB

async function uploadFile(file: Express.Multer.File) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME type
  if (!ALLOWED_TYPES.includes(file.mimetype)) {
    throw new BadRequestException('Invalid file type');
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
  if (file.size > MAX_SIZE) {
    throw new BadRequestException('File too large');
  }
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
  const filename = `${uuid()}${path.extname(file.originalname)}`;
  
  // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π originalname –Ω–∞–ø—Ä—è–º—É—é!
}
```

---

## üåê HTTPS –ò –ó–ê–ì–û–õ–û–í–ö–ò

### Security Headers

```typescript
// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π helmet
import helmet from 'helmet';

app.use(helmet());

// –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π –≤—Ä—É—á–Ω—É—é
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  res.setHeader('Content-Security-Policy', "default-src 'self'");
  next();
});
```

### CORS

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.use(cors({
  origin: [
    'https://example.com',
    'https://admin.example.com',
  ],
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400, // 24 —á–∞—Å–∞
}));

// ‚ùå –ù–ò–ö–û–ì–î–ê –≤ production
app.use(cors({ origin: '*' }));
```

---

## üìä –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### –ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å

```typescript
// ‚úÖ –õ–æ–≥–∏—Ä—É–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
logger.info('User logged in', { userId: user.id, ip: req.ip });
logger.warn('Failed login attempt', { email, ip: req.ip, attempts });
logger.error('Payment failed', { orderId, errorCode });

// ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –ª–æ–≥–∏—Ä—É–π
logger.info('Login', { email, password }); // –ü–∞—Ä–æ–ª—å!
logger.debug('Token', { accessToken });    // –¢–æ–∫–µ–Ω!
logger.info('Card', { cardNumber });       // –ü–ª–∞—Ç—ë–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!
```

### –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```typescript
// ‚úÖ –ú–∞—Å–∫–∏—Ä—É–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
function maskEmail(email: string): string {
  const [local, domain] = email.split('@');
  return `${local[0]}***@${domain}`;
}

function maskCard(card: string): string {
  return `****${card.slice(-4)}`;
}

logger.info('Payment processed', {
  email: maskEmail(user.email),
  card: maskCard(cardNumber),
});
```

---

## üìã SECURITY CHECKLIST

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ environment variables
- [ ] .env –≤ .gitignore
- [ ] HTTPS –≤–∫–ª—é—á—ë–Ω
- [ ] Security headers –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
- [ ] Rate limiting –≤–∫–ª—é—á—ë–Ω
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü–∞—Ä–æ–ª–∏ —Ö—ç—à–∏—Ä—É—é—Ç—Å—è (argon2/bcrypt)
- [ ] JWT —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
- [ ] SQL injection –∑–∞—â–∏—Ç–∞ (ORM)
- [ ] XSS –∑–∞—â–∏—Ç–∞ (CSP)
- [ ] CSRF –∑–∞—â–∏—Ç–∞

### –†–µ–≥—É–ª—è—Ä–Ω–æ

- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (npm audit)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- [ ] –†–µ–≤—å—é –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

---

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 2025-01-31
